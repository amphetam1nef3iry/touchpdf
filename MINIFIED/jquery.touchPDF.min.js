(function($){"use strict";var EMPTY="empty",INIT="init",LOADING="loading",LOADED="loaded",ZOOMEDIN="zoomedin",DRAGGING="dragging",RENDERING="rendering",PLUGIN_NS='TouchPDF',TOOLBAR_HEIGHT=30,BORDER_WIDTH=1,TAB_SPACING=-2,TAB_WIDTH=41,TAB_OFFSET_WIDTH=10,TAB_HEIGHT_EXTENDED=100,TAB_HEIGHT_SHRUNK=40,TAB_OFFSET_EXTENDED=TAB_HEIGHT_EXTENDED-TAB_HEIGHT_SHRUNK,TAB_OFFSET_EACH=5;var defaults={source:null,title:"TouchPDF",tabs:[],tabsColor:"beige",disableZoom:!1,disableSwipe:!1,disableLinks:!1,disableKeys:!1,pdfScale:1,quality:2,redrawOnWindowResize:!0,showToolbar:!0,loaded:null,changed:null,loadingHeight:841,loadingWidth:595,loadingHTML:"Loading PDF"};$.fn.pdf=function(method){var $this=$(this),plugin=$this.data(PLUGIN_NS);if(plugin&&typeof method==='string'){if(plugin[method]){return plugin[method].apply(this,Array.prototype.slice.call(arguments,1))}else{$.error('Method '+method+' does not exist on jQuery.pdf')}}
else if(!plugin&&(typeof method==='object'||!method)){return init.apply(this,arguments)}
    return $this};$.fn.pdf.defaults=defaults;function init(options){if(!options){options={}}
    options=$.extend({},$.fn.pdf.defaults,options);return this.each(function(){var $this=$(this);var plugin=$this.data(PLUGIN_NS);if(!plugin){plugin=new TouchPDF(this,options);$this.data(PLUGIN_NS,plugin)}})}
    function TouchPDF(element,options){var state=EMPTY;var totalPages=0;var pageNum=0;var pageNumMainRendering=0;var pageNumSecRendering=0;var $element=$(element);var canvas=null;var $annotations=null;var pdfDoc=null;var scale=1;var ctx=!1;var secCtx=!1;var pagesRefMap=[];var plugin=this;var tabWidth=0;var $drag=null,$viewer=null;var linksDisabled=!1;var prevPage=1;const stepsSliding=150;const delaySliding=0;const timePerStepSliding=1;let firstTime=!0;initDom();load();this.goto=function(number){goto(number);return $element};this.previous=function(){goto(pageNum-1);return $element};this.next=function(){goto(pageNum+1);return $element};this.redraw=function(){redraw();return $element};this.destroy=function(){$element.empty().removeClass("touchPDF")};this.getPageNumber=function(){return pageNum};this.getTotalPages=function(){return totalPages};function goto(number,bySlider=!1){if(state==EMPTY||state==INIT)return;if(number<1)number=1;if(number>totalPages)number=totalPages;if(number==0)return;if(number==pageNum)return;let direction;if(number>pageNum){direction=1}else{direction=0}
        pageNum=number;prevPage=number;var z=1;$element.find(".pdf-tabs .tab").each(function(i,a){var $a=$(a);var aPageNum=$a.data("page");if(aPageNum<number){$a.removeClass("right");$a.css("z-index",1000+z++)}else if(aPageNum==number){$a.removeClass("right");$a.css("z-index",1000+z++)}else{$a.addClass("right");$a.css("z-index",1000-z++)}});$(".slider").val(number);const $secCanvas=$(".sec-canvas");const $mainCanvas=$(".main-canvas");renderMainPage();setTimeout(()=>{renderSecPage()},stepsSliding*timePerStepSliding+50+delaySliding);if(firstTime||bySlider){firstTime=!1;return}
        $secCanvas.css("transform","none");$mainCanvas.css("transform","translateX(100%)");setTimeout(()=>{if(direction){for(let i=0;i<stepsSliding;i++){setTimeout(()=>{$mainCanvas.css('transform',`translateX(${100 - 100/stepsSliding * (i + 1)}%)`)},i*timePerStepSliding+delaySliding)}
            for(let i=0;i<stepsSliding;i++){setTimeout(()=>{$secCanvas.css('transform',`translateX(${-100/stepsSliding * (i + 1)}%)`)},i*timePerStepSliding+delaySliding)}}else{for(let i=0;i<stepsSliding;i++){setTimeout(()=>{$mainCanvas.css('transform',`translateX(${-(100 - 100/stepsSliding * (i + 1))}%)`)},i*timePerStepSliding+delaySliding)}
            for(let i=0;i<stepsSliding;i++){setTimeout(()=>{$secCanvas.css('transform',`translateX(${100/stepsSliding * (i + 1)}%)`)},i*timePerStepSliding+delaySliding)}}},10)}
        function initDom(){if(state!=EMPTY)return;$element.addClass("touchPDF").html('<div class="pdf-outerdiv">'+'<div class="pdf-tabs"></div>'+'<div class="pdf-toolbar"></div>'+'<div class="pdf-viewer">'+'<div class="pdf-loading">'+options.loadingHTML+'</div>'+'<div class="pdf-drag">'+'<div class="pdf-canvas">'+"<canvas class='sec-canvas'></canvas>"+'<canvas class="main-canvas"></canvas>'+'<div class="pdf-annotations"></div>'+'</div>'+'</div>'+'</div>'+'</div>');if(options.showToolbar){$element.find(".pdf-toolbar").html('<div class="pdf-title">'+options.title+'</div>'+'<div class="pdf-button"><button class="pdf-prev">&lt;</button></div>'+'<div class="pdf-button"><span class="pdf-page-count"></span></div>'+'<div class="pdf-button"><button class="pdf-next">&gt;</button></div>'+(options.disableZoom?'':'<div class="pdf-button"><button class="pdf-zoomin">+</button></div>'+'<div class="pdf-button"><button class="pdf-zoomout">-</button></div>'));$element.find(".pdf-toolbar > .pdf-title").on("click",function(){goto(1)});$element.find(".pdf-toolbar > .pdf-button > .pdf-prev").on("click",function(){goto(pageNum-1)});$element.find(".pdf-toolbar > .pdf-button > .pdf-next").on("click",function(){goto(pageNum+1)})}
            $drag=$element.find(".pdf-drag");$viewer=$element.find(".pdf-viewer");if(!options.disableKeys){$(window).keydown(function(event){if(event.keyCode==37)goto(pageNum-1);else if(event.keyCode==39)goto(pageNum+1)})}
            if(options.redrawOnWindowResize){var windowResizeTimeout=!1;$(window).resize(function(){clearTimeout(windowResizeTimeout);windowResizeTimeout=setTimeout(function(){redraw()},100)})}
            if(!options.disableZoom){$drag.panzoom({contain:'invert',minScale:1,disablePan:!0,increment:0.25,maxScale:2,onChange:function(){linksDisabled=!0;$drag.panzoom("option","disablePan",!1);state=ZOOMEDIN},onEnd:function(){setTimeout(function(){linksDisabled=!1;if($drag.panzoom("getMatrix")[0]==1)zoomReset()},1)}});$drag.panzoom('enable');$drag.parent().on('mousewheel.focal',function(e){e.preventDefault();var delta=e.delta||e.originalEvent.wheelDelta;var direction=delta?delta<0:e.originalEvent.deltaY>0;if(direction)zoomOut(e);else zoomIn(e)});if(options.showToolbar){$element.find(".pdf-toolbar > .pdf-button > .pdf-zoomin").on("click",function(){zoomIn()});$element.find(".pdf-toolbar > .pdf-button > .pdf-zoomout").on("click",function(){zoomOut()})}
                if(!options.disableLinks){var touchlink=null;$drag.on('touchstart',"a",function(e){touchlink=this;setTimeout(function(){touchlink=null},100)});$drag.on('touchend',"a",function(e){if(this==touchlink){e.stopImmediatePropagation();this.click()}})}}
            if(!options.disableSwipe){$viewer.swipe({swipe:function(event,direction,distance,duration,fingerCount,fingerData){if(state!=LOADED)return;linksDisabled=!0;setTimeout(function(){linksDisabled=!1},1);if(direction=="right")goto(pageNum-1);else if(direction=="left")goto(pageNum+1)},threshold:50,excludedElements:".noSwipe"})}
            canvas=$element.find(".main-canvas")[0];ctx=canvas.getContext('2d');secCtx=$(".sec-canvas")[0].getContext("2d");$annotations=$element.find(".pdf-annotations");state=INIT;redraw()}
        function zoomIn(focal){if(options.disableZoom)return;if(state!=ZOOMEDIN&&state!=LOADED)return;state=ZOOMEDIN;$drag.panzoom('zoom',!1,{increment:0.25,animate:!0,focal:focal});linksDisabled=!1}
        function zoomOut(focal){if(options.disableZoom)return;if(state!=ZOOMEDIN)return;$drag.panzoom('zoom',!0,{increment:0.25,animate:!0,focal:focal});linksDisabled=!1;if($drag.panzoom("getMatrix")[0]==1)zoomReset()}
        function zoomReset(){if(options.disableZoom)return;$drag.panzoom('reset');linksDisabled=!1;$drag.panzoom("option","disablePan",!0);state=LOADED}
        function load(){if(state!=INIT)return;state=LOADING;let pages=0;$(".pdf-tabs").css("padding-bottom","50px");PDFJS.getDocument(options.source).then(function(pdfDoc_){pdfDoc=pdfDoc_;totalPages=pdfDoc.numPages;pages=totalPages;if(totalPages<1)return;state=LOADED;if(options.loaded)options.loaded()
            goto(1)});const $slider=$("<input type='range' min='1' max='23'/>");$slider.attr('value','1');$slider.addClass('slider');setTimeout(()=>{$slider.attr("max",pages);$slider.on("input",(e)=>{let curPage=e.target.value;goto(+curPage,!0)})},200);$(".pdf-tabs").after($slider);if(options.tabs&&$.isArray(options.tabs)){var top=[];var maxOffset=0;$.each(options.tabs,function(i,tab){if(tab.offset&&tab.offset>maxOffset)maxOffset=tab.offset});tabWidth=TAB_WIDTH+TAB_OFFSET_WIDTH*maxOffset;$.each(options.tabs,function(i,tab){var offset=tab.offset||0;if(top[offset]===undefined){top[offset]=5+TOOLBAR_HEIGHT}
            var $a=$("<a>").addClass("tab").data("page",tab.page).data("index",i+1).css("height",`${TAB_HEIGHT_SHRUNK}px`).css("margin-left",offset*TAB_OFFSET_WIDTH+"px").css("margin-right",(maxOffset-offset)*TAB_OFFSET_WIDTH+"px").click(function(){function tabExpand(el){el.animate({"height":`${TAB_HEIGHT_EXTENDED}px`},150,()=>{el.find('span').css("display","block")})}
                function tabShrink(el){el.animate({"height":`${TAB_HEIGHT_SHRUNK}px`},100,()=>{el.find('span').css("display","none")})}
                function tabsDown(tabs){tabs.animate({"top":`+=${TAB_OFFSET_EXTENDED}px`},100)}
                function tabsUp(tabs){tabs.animate({"top":`-=${TAB_OFFSET_EXTENDED}px`},100)}
                const data=+$(".pdf-tabs").data("activated");const curIndex=+$(this).data("index");if(!data||curIndex!=data){if(data&&curIndex!=data){tabsUp($(`.tab:gt(${data - 1})`))}
                    tabShrink($('.tab'));tabsDown($(`.tab:gt(${curIndex - 1})`));tabExpand($(this));$(".pdf-tabs").data("activated",curIndex)}else{tabShrink($(this));tabsUp($(`.tab:gt(${curIndex - 1})`));$(".pdf-tabs").data("activated",0);if(tab.page==pageNumSecRendering)goto(tab.page-1,!0);else goto(tab.page,!0)}});var $span=$("<span>").html(tab.title).appendTo($a);if(tab.bottom!==undefined){$a.css("bottom",tab.bottom)}else{if(tab.top!==undefined)top[offset]=tab.top+TOOLBAR_HEIGHT;$a.css("top",top[offset]+TAB_OFFSET_EACH*(i+1))}
            if(tab.title.length>2)$a.addClass("large");if(!tab.color)tab.color=options.tabsColor;$a.addClass(tab.color);if(tab.height){$a.css("height",tab.height);$span.css("width",tab.height)}
            $span.css('display','none');$element.find(".pdf-tabs").append($a);if(tab.bottom===undefined)top[offset]+=$a.height()+TAB_SPACING})}}
        function renderMainPage(){if(state!=LOADED&&state!=ZOOMEDIN)return;if(pageNum==pageNumMainRendering)return;zoomReset();state=RENDERING;pageNumMainRendering=pageNum;updatePageCount();pdfDoc.getPage(pageNumMainRendering).then(function(page){var viewport=page.getViewport(options.pdfScale*options.quality);canvas.height=viewport.height;canvas.width=viewport.width;$(".pdf-canvas").css("transform","scale("+(1/options.quality)+")").css("transform-origin","top left");var renderTask=page.render({canvasContext:ctx,viewport:viewport});if(!options.disableLinks){renderAnnotations(page,viewport)}
            renderTask.promise.then(function(){state=LOADED;if(pageNumMainRendering!=pageNum||pageNumMainRendering!=prevPage){renderMainPage()}});redraw();$element.find(".pdf-loading").hide();$element.find(".pdf-tabs").css("visibility","visible");$element.find(".main-canvas").css("visibility","visible");if(options.changed)options.changed()})}
        function renderSecPage(){state=RENDERING;pageNumSecRendering=prevPage;pdfDoc.getPage(prevPage).then(function(page){var viewport=page.getViewport(options.pdfScale*options.quality);const $secCanvas=$(".sec-canvas");$secCanvas.attr("width",viewport.width);$secCanvas.attr("height",viewport.height);if(!options.disableLinks){renderAnnotations(page,viewport)}
            var renderTaskSec=page.render({canvasContext:secCtx,viewport:viewport});renderTaskSec.promise.then(function(){state=LOADED;if(pageNumSecRendering!=pageNum||pageNumSecRendering!=prevPage){renderSecPage()}});redraw();$secCanvas.css({visibility:"visible",position:"absolute",top:"0",transform:"translateX(-100%)"})})}
        function redraw(){if(state==INIT){var pdfHeight=options.loadingHeight;var pdfWidth=options.loadingWidth}else{var pdfHeight=canvas.height/options.quality;var pdfWidth=canvas.width/options.quality}
            var winHeight=$element.height();var winWidth=$element.width();scale=Math.min(winHeight/(pdfHeight+TOOLBAR_HEIGHT+BORDER_WIDTH*2),winWidth/(pdfWidth+tabWidth*2+BORDER_WIDTH*2));if(scale>1)scale=1;$element.find(".pdf-outerdiv").css("transform","scale("+scale+")").css("width",pdfWidth+BORDER_WIDTH*2).css("height",pdfHeight+TOOLBAR_HEIGHT+BORDER_WIDTH*2).css("padding","0 "+tabWidth+"px").css("left",(winWidth-scale*(pdfWidth+tabWidth*2+BORDER_WIDTH*2))/2);$element.find(".pdf-toolbar").css("width",pdfWidth).css("height",TOOLBAR_HEIGHT).css("left",tabWidth+BORDER_WIDTH);$viewer.css("width",pdfWidth).css("height",pdfHeight).css("left",tabWidth).css("top",TOOLBAR_HEIGHT).css("border-width",BORDER_WIDTH);$drag.css("width",pdfWidth).css("height",pdfHeight);if(!options.disableZoom){$drag.panzoom('resetDimensions')}
            if(!options.disableSwipe){$viewer.swipe("option","threshold",75*scale)}}
        function updatePageCount(){if(state==EMPTY||state==INIT)return;$element.find(".pdf-page-count").html(pageNum+" / "+totalPages)}
        function getPageIndex(destRef){var defer=$.Deferred();if(pagesRefMap[destRef.num+' '+destRef.gen+' R']){defer.resolve(pagesRefMap[destRef.num+' '+destRef.gen+' R'])}else{pdfDoc.getPageIndex(destRef).then(function(pageIndex){pagesRefMap[destRef.num+' '+destRef.gen+' R']=pageIndex+1;defer.resolve(pageIndex+1)})}
            return defer.promise()}
        function renderAnnotations(page,viewport){if(state!=RENDERING)return;$annotations.empty();page.getAnnotations().then(function(annotationsData){viewport=viewport.clone({dontFlip:!0});$.each(annotationsData,function(i,data){if(!data||!data.hasHtml||data.subtype!=='Link'||(!data.dest&&!data.url))return;var $el=$(PDFJS.AnnotationUtils.getHtmlElement(data,page.commonObjs));var rect=data.rect;var view=page.view;rect=PDFJS.Util.normalizeRect([rect[0],view[3]-rect[1]+view[1],rect[2],view[3]-rect[3]+view[1]]);$el.css("left",rect[0]+'px').css("top",rect[1]+'px').css("position",'absolute');var transform=viewport.transform;var transformStr='matrix('+transform.join(',')+')';$el.css('transform',transformStr);var transformOriginStr=-rect[0]+'px '+ -rect[1]+'px';$el.css('transformOrigin',transformOriginStr);var link=$el.find("a").on('mousedown',function(e){e.preventDefault()});if(data.url){link.addClass("externalLink").attr("href",data.url).attr("target","_blank")}else if(data.dest){link.addClass("internalLink").data("dest",data.dest).on('click',function(e){if(state!=LOADED&&state!=ZOOMEDIN)return!1;if(linksDisabled)return!1;var dest=$(this).data("dest");if(dest instanceof Array){getPageIndex(dest[0]).then(function(num){if(state!=LOADED&&state!=ZOOMEDIN)return;goto(num)})}else{pdfDoc.getDestination($(this).data("dest")).then(function(destRefs){if(!(destRefs instanceof Array))return;getPageIndex(destRefs[0]).then(function(num){if(state!=LOADED&&state!=ZOOMEDIN)return;if(linksDisabled)return;goto(num)})})}
            return!1})}
            $annotations.append($el)})})}}})(jQuery)
